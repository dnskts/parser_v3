Universal Supplier Parser for B24 CRM
=====================================

Простой и расширяемый фронтенд-проект для унификации выгрузок от разных поставщиков (**авиа / ж/д / отели / трансферы**).  
Работает полностью в браузере (**JS + HTML + CSS**), без сервера и без PHP — **нужен только любой статический HTTP-сервер** для локального запуска.

**Ключевые принципы:**

*   **1 файл = 1 поставщик.** Чтобы добавить нового — кладёте **один** `.js` файл в `client/parsers/xml/` и всё.

*   **Автоопределение формата XML.** Система сама находит нужный парсер.

*   **Единая таблица и единая схема полей.** Все данные приводятся к одному формату, с типами и правилами.

*   **Множественная загрузка файлов.** Можно загрузить пачку XML — записи накапливаются в одной таблице.

*   **Экспорт JSON** в общий формат (ветки `air/rail/hotel/transfer` + `raw.payloadRef`).


* * *

Структура проекта
-----------------



`/public`  
`/modules`  
--`api-loader.js` # Заготовка: подключение API-поставщиков (в будущем)  
--`auto-import.js` # Заготовка: автозагрузка из папки (FTP) через бэкенд  
--`exporter.js` # Экспорт собранной таблицы в единый JSON  
--`loader.js` # Загрузка файлов (input + drag&drop, множественный выбор)  
--`parser-registry.js` # Автоопределение поставщика + динамическая загрузка парсера  
--`schema.js` # Единая схема полей + типы + вычисление "Дата реализации"  
--`table.js` # Рендер таблицы, форматирование по типам, бейджи статусов  
--`app.js` # Точка входа: склейка модулей, состояние, UI-логика  
--`index.html` # Главная страница  
--`styles.css` # Единый стиль (в стиле Bitrix24)  
`/client`  
`/parsers`  
`/xml`  
--`myagent_air.js` # Пример реального парсера "МойАгент (авиа)"  
--`example_air.js` # Учебный пример (авиа)  
--`example_rail.js` # Учебный пример (ж/д)  
--`server.mjs` # (необязательно) лёгкий dev-сервер на Node.js  
`README.md` # Этот файл`

* * *

Быстрый старт
-------------

### Вариант 1 — PhpStorm (Node.js, одной кнопкой)

1.  Убедитесь, что в корне есть `server.mjs` (статический сервер).

2.  В PhpStorm: **Run → Edit Configurations… → + → Node.js**

    *   **JavaScript file:** `server.mjs`

    *   **Working directory:** корень проекта (где видны `public/` и `client/`)

3.  Запустите (**Run**) и откройте:  
    `http://127.0.0.1:8000/public/index.html`


> **Важно:** document root должен быть **корнем проекта**, иначе динамическая загрузка парсеров (`/client/parsers/...`) даст 404.

### Альтернативы

*   **PHP built-in:**



    `php -S localhost:8000 -t .`

*   **Python:**



    `python -m http.server 8000`

*   **VS Code Live Server:**  
    Откройте `public/index.html` через Live Server (document root — корень).


**Почему нельзя `file://…`?**  
Браузеры блокируют ES-модули (CORS) при открытии файлов напрямую. Используйте `http://localhost…`.

* * *

Как пользоваться
----------------

1.  Откройте `http://localhost:8000/public/index.html`.

2.  Нажмите **«Загрузить XML»** и выберите **один или несколько** XML-файлов **или** перетащите их на зону DnD.

3.  Таблица заполнится строками (все файлы **накапливаются** в одной таблице).

4.  Над таблицей отображается: **Парсер: … Файл: …** — для **последнего** обработанного файла.

5.  Нажмите **«Экспорт в JSON»** — получите единый JSON: ветки `air/rail/hotel/transfer` + `raw.payloadRef` (исходный XML последнего файла).


* * *

Обзор модулей
-------------

### `/public/modules/loader.js` — загрузка файлов

*   Поддержка `input[type=file][multiple]` и **drag&drop**.

*   Для каждого файла читает текст (UTF-8) и вызывает:  
    `onFileContent(content, fileName)`.


### `/public/modules/parser-registry.js` — автоопределение + подгрузка парсера

*   **Определение поставщика из XML:**

    *   `<Supplier code="...">` → `supplierCode = code`, `category = атрибут category` (если есть).

    *   `<order_snapshot>` (формат «МойАгент») → `supplierCode = 'myagent_air'`, `category = 'air'`.

*   **Динамическая загрузка:**  
    `../../client/parsers/xml/<supplierCode>.js` (относительно модуля) через `new URL(..., import.meta.url)`.


> Это позволяет просто положить файл парсера, **не меняя** код приложения.

### `/public/modules/schema.js` — единая схема полей

*   Список колонок `{ key, title, type }` с типами:  
    `string | integer | number | date | boolean`.

*   `normalizeRows(rows)`:

    *   добавляет отсутствующие поля;

    *   приводит типы:

        *   числовые → `number`;

        *   булевы → `true/false` (распознаёт `да/нет`, `1/0`, `true/false`);

        *   даты → ISO-строка `YYYY-MM-DD HH:mm:ss`;

    *   вычисляет **«Дата реализации»**:

        *   `air/rail` → `issueDate`;

        *   `hotel` → `checkOutDate` (если появится), иначе `issueDate`;

        *   прочее → `issueDate`.


### `/public/modules/table.js` — отрисовка таблицы

*   Таблица на всю ширину, **горизонтальная прокрутка**, стиль «Bitrix-like».

*   Заголовки — **Первая буква заглавная**, уменьшенный шрифт (как и у контента).

*   Форматирование по типу (числа: `ru-RU`, boolean: `Да/Нет`, даты — ISO).

*   Подсветка в колонке **«Операция»**:

    *   **Продажа** — зелёный бейдж;

    *   **Возврат / Войд** — красный бейдж;

    *   **Обмен** — жёлтый бейдж.


### `/public/modules/exporter.js` — экспорт JSON

*   Поддерживает:

    *   **Старый режим:** `{ category, rows }` → вся пачка в одну ветку.

    *   **Новый режим:** `{ rows }` → строки могут иметь **разные** `row.category`, экспорт сам разложит по `air/rail/hotel/transfer`.

*   `raw.payloadRef` — исходный XML **последнего** обработанного файла (по желанию можно расширить под массив).


### `/public/modules/api-loader.js` и `/public/modules/auto-import.js`

*   **Заготовки**:

    *   `api-loader.js` — для будущих API-поставщиков (fetch, токены, пагинация).

    *   `auto-import.js` — для автоподхвата XML с FTP через небольшой бэкенд.


### `/public/app.js` — склейка всех частей

*   Держит состояние: **накопленные строки**, массив сырых XML, имя парсера/файла, счётчик файлов.

*   На каждый файл:

    1.  автоопределяет поставщика;

    2.  динамически загружает парсер;

    3.  парсит;

    4.  приводит к схеме и **добавляет** строки в таблицу;

    5.  обновляет «**Парсер: … Файл: …**».


* * *

Добавление нового поставщика (XML)
----------------------------------

1.  Убедитесь, как обозначен ваш формат в XML:

    *   **A.** `<Supplier code="my_supplier" category="air">`

    *   **B.** Специфичный корень (например, `<order_snapshot>` у «МойАгент»).

2.  Создайте **один** файл: `client/parsers/xml/<code>.js`.

    *   Для A: `client/parsers/xml/my_supplier.js`.

    *   Для B: если корень новый — добавьте короткую проверку в `detectFromXml` (в `parser-registry.js`).

3.  Экспортируйте объект с методом `parse(xmlText)`:



    `// client/parsers/xml/my_supplier.js export default { supplierCode: 'my_supplier', displayName: 'МойПоставщик (авиа)', // опционально, красиво в UI async parse(xmlText){ const doc = new DOMParser().parseFromString(xmlText, 'text/xml'); // Соберите rows -> массив объектов под ключи из Schema.getColumns() const rows = [{ category: 'air', // важно для экспорта! nomerProdukta: '...', issueDate: '2025-10-13 12:16:00', operatsiya: 'Продажа', // или Возврат / Войд / Обмен // ... остальные поля по возможности }]; return { category: 'air', rows }; } };`

4.  Готово — загрузите XML, таблица обновится сама.


> **Важно:** возвращайте `category` (`'air'|'rail'|'hotel'|'transfer'`).  
> Поля, которых нет у конкретного поставщика, можно опускать — нормализатор их добавит и корректно приведёт типы.

* * *

Пример: «МойАгент (авиа)»
-------------------------

`client/parsers/xml/myagent_air.js` поддерживает **продажи** и **возвраты** для `<order_snapshot>`:  
извлекает номер билета, даты, PNR, маршрут, суммы, комиссию, таксы, валюту, EMD, штраф, код перевозчика и операцию.  
Если в заказе несколько билетов — в таблицу попадает **строка на каждый**.

* * *

FAQ (частые проблемы)
---------------------

**CORS / origin 'null' / Failed to load module script**  
— Страницу открыли как `file://…`. Нужно `http://localhost…`.

**404 на `/client/parsers/xml/...`**  
— Сервер запущен не из **корня** проекта. Document root должен быть корнем.

**После выбора файла «тишина»**  
— Старый `parser-registry.js` не распознаёт формат. Используйте версию с поддержкой `<order_snapshot>` (для «МойАгент»).

**Колонка «Операция» не подсвечивается**  
— Значение должно быть «Продажа», «Возврат», «Войд», «Обмен» (регистр не важен). Неизвестные строки выводятся без бейджа.

* * *

Расширение: API и автозагрузка
------------------------------

*   **API-поставщики:** реализуйте обращение в `modules/api-loader.js`, затем добавляйте данные в таблицу в том же формате (через `Schema.normalizeRows()` → `Table.setRows()`).

*   **Автозагрузка с FTP:** понадобится небольшой бэкенд (Node/PHP) для опроса папки/FTP. Заготовка интерфейса есть в `modules/auto-import.js`.


* * *

Рекомендации к парсерам
-----------------------

*   Идентификаторы/коды — хранить **строкой** (без потери ведущих нулей).

*   Денежные поля — можно строкой; нормализатор приведёт к `number`.

*   Даты — любые понятные (`YYYY-MM-DD HH:mm:ss` / `DD.MM.YYYY HH:mm`); нормализатор приведёт к ISO-строке.

*   Булевы — `да/нет`, `true/false`, `1/0` — будут приведены к `boolean`.


* * *

Планы на улучшение
------------------

*   Кнопки **«Очистить таблицу»**, **«Отменить последнюю загрузку»**.

*   Бейджи для других полей (например, EMD).

*   Поддержка CSV/JSON во входе (расширить `loader.js`).

*   Сохранение/загрузка пресетов схемы из внешнего JSON.


* * *

Лицензия и вклад
----------------

Внутренний проект. Коммиты — с понятными сообщениями.  
Не меняйте публичные интерфейсы модулей без обновления этого README.

* * *

### TL;DR

*   Добавить поставщика = положить **1 файл** в `client/parsers/xml/` с `parse(xmlText)`.

*   Запуск — **любой** статический сервер из **корня проекта**.

*   Загружайте XML пачками, смотрите таблицу, жмите «Экспорт в JSON».





======